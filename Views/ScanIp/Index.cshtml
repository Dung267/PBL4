@{
    ViewData["Title"] = "IP Scan";
}

<link rel="stylesheet" href="~/css/scanip.css" asp-append-version="true" />

<div class="scan-container">
    <h3 class="scan-title">🔍 IP Scan Tool</h3>

    <div class="scan-card">
        <!-- Input Section -->
        <div class="input-section">
            <div class="form-group">
                <label class="form-label">📍 Nhập IP hoặc dải IP:</label>
                <input type="text" id="ipRange" class="form-control"
                       placeholder="Ví dụ: 192.168.1.1 hoặc 192.168.1.1-192.168.1.20" />
            </div>

            <div class="settings-row">
                <div class="setting-group">
                    <label class="form-label">⏱️ Timeout (ms):</label>
                    <input type="number" id="timeout" class="form-control small" value="700" min="100" max="5000" />
                </div>

                <div class="setting-group">
                    <label class="form-label">⚡ Max parallel:</label>
                    <input type="number" id="parallel" class="form-control small" value="150" min="1" max="500" />
                </div>

                <button id="startBtn" class="btn btn-primary">🚀 Start Scan</button>
            </div>
        </div>

        <!-- Status -->
        <div id="status" class="status-message"></div>

        <!-- Results Table -->
        <table id="resultsTable" class="results-table">
            <thead>
                <tr>
                    <th>IP Address</th>
                    <th>Status</th>
                    <th>RTT (ms)</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script>
        const btn = document.getElementById('startBtn');
        const status = document.getElementById('status');
        const tbl = document.getElementById('resultsTable');
        const tbody = tbl.querySelector('tbody');

        btn.addEventListener('click', async () => {
            const ipRange = document.getElementById('ipRange').value.trim();
            if (!ipRange) {
                alert('Vui lòng nhập IP hoặc dải IP');
                return;
            }

            btn.disabled = true;
            btn.textContent = '🔄 Scanning...';
            status.innerText = '🔄 Đang quét...';
            status.className = 'status-message scanning';
            tbody.innerHTML = '';
            tbl.style.display = 'none';

            const payload = {
                range: ipRange,
                timeoutMs: parseInt(document.getElementById('timeout').value) || 700,
                maxParallel: parseInt(document.getElementById('parallel').value) || 150
            };

            try {
                const resp = await fetch('/ScanIp/Start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const j = await resp.json();
                if (!resp.ok) throw new Error(j?.error || 'Server error');

                status.innerText = `✅ Hoàn thành: ${j.results.length} địa chỉ`;
                status.className = 'status-message success';

                if (j.results.length) {
                    tbl.style.display = 'table';
                    j.results.forEach(r => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                                    <td>${r.ip}</td>
                                    <td class="status-cell ${r.alive ? 'alive' : 'dead'}">
                                        ${r.alive ? '✅ Online' : '❌ Offline'}
                                    </td>
                                    <td>${r.rttMs ?? '-'}</td>
                                `;
                        tbody.appendChild(tr);
                    });
                }
            } catch (err) {
                status.innerText = '❌ Lỗi: ' + (err.message || err);
                status.className = 'status-message error';
            } finally {
                btn.disabled = false;
                btn.textContent = '🚀 Start Scan';
            }
        });

        // Enter key support
        document.getElementById('ipRange').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                document.getElementById('startBtn').click();
            }
        });
    </script>
}